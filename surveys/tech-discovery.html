<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Technology & Application Discovery Survey — RCO IT</title>
  <link rel="stylesheet" href="../styles.css"/>
  <style>
    .step { display: none; }
    .step.active { display: block; }

    .step-header { margin-bottom: 1.75rem; padding-bottom: 1.25rem; border-bottom: 1px solid var(--sb-sep); }
    .step-header h2 { font-size: 1.3rem; font-weight: 800; color: var(--sb-text); margin-bottom: 0.3rem; }
    .step-header p  { font-size: 0.875rem; color: var(--sb-muted); line-height: 1.6; }

    .howto-steps { display: flex; flex-direction: column; gap: 0.75rem; margin: 1.25rem 0 1.75rem; }
    .howto-step { display: flex; gap: 1rem; align-items: flex-start; background: var(--sidebar-bg); border: 1.5px solid var(--sb-border); border-radius: 12px; padding: 0.9rem 1.1rem; }
    .howto-step-num { width: 28px; height: 28px; border-radius: 50%; background: var(--brand-grad); color: #fff; font-size: 0.78rem; font-weight: 800; flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
    .howto-step-text strong { display: block; font-size: 0.875rem; color: var(--sb-text); margin-bottom: 0.2rem; }
    .howto-step-text span   { font-size: 0.8rem; color: var(--sb-muted); line-height: 1.5; }

    .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; max-width: 540px; }
    @media(max-width:600px){ .info-grid { grid-template-columns: 1fr; } }
    .field-wrap { display: flex; flex-direction: column; gap: 0.35rem; }
    .field-wrap label { font-size: 0.82rem; font-weight: 700; color: var(--sb-text); }
    .field-wrap input, .field-wrap select {
      background: var(--sidebar-bg); border: 1.5px solid var(--sb-border); border-radius: 9px;
      padding: 0.6rem 0.85rem; font-size: 0.875rem; font-family: inherit; color: var(--sb-text);
      outline: none; width: 100%; transition: border-color 0.15s, box-shadow 0.15s;
    }
    .field-wrap input:focus, .field-wrap select:focus {
      border-color: var(--brand-hover-border); box-shadow: 0 0 0 3px rgba(189,153,121,0.15);
    }

    /* ── Software table ── */
    .sw-table-wrap { overflow-x: auto; margin-bottom: 1rem; }
    .sw-table { width: 100%; border-collapse: collapse; font-size: 0.82rem; table-layout: fixed; }
    .sw-table thead th {
      text-align: left; font-size: 0.68rem; font-weight: 800; text-transform: uppercase;
      letter-spacing: 0.05em; color: var(--sb-muted); padding: 0 0.75rem 0.65rem;
      border-bottom: 1.5px solid var(--sb-sep);
    }
    .sw-table tbody td { padding: 0.55rem 0.75rem; border-bottom: 1px solid var(--sb-sep); vertical-align: middle; }
    .sw-table tbody tr:hover td { background: var(--sidebar-bg); }
    .sw-name-input {
      background: transparent; border: none; outline: none;
      font-size: 0.82rem; font-weight: 700; font-family: inherit;
      color: var(--sb-text); width: 100%;
      border-bottom: 1.5px dashed var(--sb-border); padding-bottom: 2px;
      transition: border-color 0.15s; display: block;
    }
    .sw-name-input:focus { border-color: var(--brand-hover-border); }
    .sw-name-input::placeholder { font-weight: 400; color: var(--sb-muted); }

    .sev-dots { display: flex; gap: 3px; align-items: center; }
    .sev-dot  { width: 9px; height: 9px; border-radius: 50%; background: var(--sb-sep); }
    .sev-dot.on { background: var(--brand-brown); }

    .pill-sm { font-size: 0.68rem; font-weight: 700; padding: 0.18rem 0.5rem; border-radius: 999px; white-space: nowrap; }
    .pill-yes { background: var(--success-soft); color: var(--success); }
    .pill-no  { background: rgba(220,80,60,0.08); color: #c0392b; }
    .pill-na  { background: var(--sidebar-bg); color: var(--sb-muted); border: 1px solid var(--sb-border); }

    .edit-btn {
      font-size: 0.7rem; font-weight: 700; font-family: inherit; cursor: pointer;
      padding: 0.28rem 1.1rem; border-radius: 6px; white-space: nowrap;
      background: var(--brand-soft); border: 1.5px solid var(--brand-hover-border);
      color: var(--brand-brown); transition: all 0.15s; line-height: 1.4;
    }
    .edit-btn:hover { background: var(--brand-grad); color: #fff; border-color: var(--brand-brown); }
    .edit-btn.done  { background: var(--brand-soft); border-color: var(--brand-hover-border); color: var(--brand-brown); }
    .edit-btn.done:hover { background: var(--brand-grad); color: #fff; border-color: var(--brand-brown); }

    .remove-btn {
      font-size: 0.7rem; font-weight: 700; font-family: inherit; cursor: pointer;
      padding: 0.25rem 0.5rem; border-radius: 6px;
      background: none; border: 1.5px solid var(--sb-border); color: var(--sb-muted);
      transition: all 0.15s; line-height: 1.4;
    }
    .remove-btn:hover { border-color: #c0392b; color: #c0392b; }

    .add-sw-btn {
      width: 100%; padding: 0.8rem; margin-top: 0.25rem;
      border: 2px dashed var(--sb-border); border-radius: 12px;
      background: none; color: var(--sb-muted);
      font-size: 0.875rem; font-weight: 700; font-family: inherit;
      cursor: pointer; transition: all 0.18s;
    }
    .add-sw-btn:hover { border-color: var(--brand-hover-border); color: var(--brand-brown); background: var(--brand-soft); }

    /* ── Details panel ── */
    .details-panel { display: none; }
    .details-panel.active { display: block; }
    .details-back {
      display: inline-flex; align-items: center; gap: 0.5rem;
      background: none; border: none; color: var(--sb-muted);
      font-family: inherit; font-size: 0.82rem; font-weight: 700;
      cursor: pointer; padding: 0; margin-bottom: 1.5rem; transition: color 0.15s;
    }
    .details-back:hover { color: var(--brand-brown); }
    .details-context { background: var(--sidebar-bg); border: 1.5px solid var(--sb-border); border-radius: 12px; padding: 0.9rem 1.25rem; margin-bottom: 1.75rem; }
    .details-context-name { font-size: 1.1rem; font-weight: 800; color: var(--sb-text); }
    .details-context-sub  { font-size: 0.78rem; color: var(--sb-muted); margin-top: 0.15rem; }

    .detail-q { margin-bottom: 1.5rem; }
    .detail-q label { display: block; font-size: 0.95rem; font-weight: 700; color: var(--sb-text); margin-bottom: 0.2rem; }
    .detail-q .q-sub { font-size: 0.8rem; color: var(--sb-muted); margin-bottom: 0.65rem; display: block; }

    .pill-group { display: flex; gap: 0.4rem; flex-wrap: wrap; }
    .pill-btn {
      padding: 0.42rem 1rem; border-radius: 999px;
      border: 1.5px solid var(--sb-border); background: var(--panel-bg);
      color: var(--sb-text); font-size: 0.82rem; font-weight: 600;
      font-family: inherit; cursor: pointer; transition: all 0.15s;
    }
    .pill-btn:hover { border-color: var(--brand-hover-border); }
    .pill-btn.selected { background: var(--brand-grad); border-color: var(--brand-brown); color: #fff; }

    .sev-group { display: flex; gap: 0.5rem; align-items: center; }
    .sev-btn {
      width: 42px; height: 42px; border-radius: 10px;
      border: 1.5px solid var(--sb-border); background: var(--panel-bg);
      font-size: 0.9rem; font-weight: 800; font-family: inherit; color: var(--sb-muted);
      cursor: pointer; transition: all 0.15s; display: flex; align-items: center; justify-content: center;
    }
    .sev-btn:hover { border-color: var(--brand-hover-border); color: var(--brand-brown); }
    .sev-btn.selected { background: var(--brand-grad); border-color: var(--brand-brown); color: #fff; }
    .sev-labels { display: flex; justify-content: space-between; font-size: 0.68rem; color: var(--sb-muted); margin-top: 0.3rem; max-width: 230px; }

    .detail-input {
      width: 100%; max-width: 420px; background: var(--sidebar-bg);
      border: 1.5px solid var(--sb-border); border-radius: 9px; padding: 0.6rem 0.9rem;
      font-size: 0.875rem; font-family: inherit; color: var(--sb-text); outline: none;
      transition: border-color 0.15s, box-shadow 0.15s;
    }
    .detail-input:focus { border-color: var(--brand-hover-border); box-shadow: 0 0 0 3px rgba(189,153,121,0.15); }

    .detail-textarea {
      width: 100%; background: var(--sidebar-bg); border: 1.5px solid var(--sb-border);
      border-radius: 9px; padding: 0.6rem 0.9rem; font-size: 0.875rem; font-family: inherit;
      color: var(--sb-text); outline: none; resize: vertical;
      transition: border-color 0.15s, box-shadow 0.15s;
    }
    .detail-textarea:focus { border-color: var(--brand-hover-border); box-shadow: 0 0 0 3px rgba(189,153,121,0.15); }
    .skip-hint { font-size: 0.72rem; color: var(--sb-muted); font-style: italic; margin-top: 0.3rem; }

    /* ── Review ── */
    .review-card { background: var(--sidebar-bg); border: 1.5px solid var(--sb-border); border-radius: 14px; padding: 1.25rem 1.5rem; margin-bottom: 1.25rem; }
    .review-card h3 { font-size: 0.75rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em; color: var(--sb-muted); margin-bottom: 0.75rem; }
    .review-sw-item {
      display: flex; align-items: center; justify-content: space-between;
      padding: 0.6rem 0.9rem; border-radius: 10px;
      background: var(--panel-bg); border: 1px solid var(--sb-border);
      margin-bottom: 0.45rem; font-size: 0.82rem;
    }
    .review-sw-item strong { color: var(--sb-text); font-weight: 700; }
    .review-sw-item span   { color: var(--sb-muted); font-size: 0.75rem; text-align: right; max-width: 55%; }

    /* ── Modal ── */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.45); backdrop-filter: blur(6px); z-index: 300; display: flex; align-items: center; justify-content: center; padding: 1rem; }
    .modal-overlay.hidden { display: none; }
    .modal-box { background: var(--panel-bg); border: 1.5px solid var(--sb-border); border-radius: 20px; padding: 1.75rem; max-width: 640px; width: 100%; max-height: 82vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.2); }
    .modal-box h3 { font-size: 1.05rem; font-weight: 800; color: var(--sb-text); margin-bottom: 1.1rem; }
    .modal-tabs { display: flex; gap: 0.4rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
    .modal-tab { padding: 0.38rem 0.9rem; border-radius: 999px; font-size: 0.78rem; font-weight: 700; font-family: inherit; border: 1.5px solid var(--sb-border); background: var(--panel-bg); color: var(--sb-muted); cursor: pointer; transition: all 0.15s; }
    .modal-tab.active { background: var(--brand-grad); border-color: transparent; color: #fff; }
    .modal-tab-content { display: none; }
    .modal-tab-content.active { display: block; }
    .modal-category { margin-bottom: 1.25rem; }
    .modal-category h4 { font-size: 0.72rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em; color: var(--sb-muted); margin-bottom: 0.5rem; }
    .modal-apps { display: flex; flex-wrap: wrap; gap: 0.4rem; }
    .modal-app-tag { background: var(--sidebar-bg); border: 1px solid var(--sb-border); border-radius: 8px; padding: 0.28rem 0.65rem; font-size: 0.78rem; color: var(--sb-text); font-weight: 600; }
    .owners-table { width: 100%; border-collapse: collapse; font-size: 0.82rem; }
    .owners-table th { text-align: left; font-size: 0.68rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em; color: var(--sb-muted); padding: 0 0.75rem 0.6rem; border-bottom: 1.5px solid var(--sb-sep); }
    .owners-table td { padding: 0.5rem 0.75rem; border-bottom: 1px solid var(--sb-sep); color: var(--sb-text); }
    .owners-table tr:last-child td { border-bottom: none; }
    .modal-close { width: 100%; margin-top: 1.25rem; padding: 0.65rem; background: var(--brand-grad); color: #fff; border: none; border-radius: 10px; font-size: 0.875rem; font-weight: 700; font-family: inherit; cursor: pointer; }
  </style>
</head>
<body>
<div class="app-shell">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="sidebar-logo-wrap">
      <img src="../logo.png" alt="Rowe Casa Organics" class="sidebar-logo"/>
    </div>
    <div class="sidebar-divider"></div>
    <nav class="sidebar-nav">
      <button class="nav-btn step-nav-btn active" onclick="goTo(0)"><span class="step-num">1</span> Overview</button>
      <button class="nav-btn step-nav-btn"         onclick="goTo(1)"><span class="step-num">2</span> Your Info</button>
      <button class="nav-btn step-nav-btn"         onclick="goTo(2)"><span class="step-num">3</span> Software Details</button>
      <button class="nav-btn step-nav-btn"         onclick="goTo(3)"><span class="step-num">4</span> Review & Submit</button>
    </nav>
    <div class="sidebar-footer">
      <div class="sidebar-divider" style="margin-bottom:0.75rem"></div>
      <button class="contact-btn" onclick="window.location.href='../index.html'">← Back to Portal</button>
      <div class="portal-label">RCO IT Help Site</div>
      <div class="portal-sub">@rowecasaorganics.com</div>
    </div>
  </aside>

  <!-- MAIN -->
  <div class="main-wrap">
    <header class="topbar">
      <div class="topbar-left">
        <div class="topbar-title">Technology & Application Discovery Survey</div>
        <div class="topbar-desc">Help us track every app and software your team uses.</div>
      </div>
      <div class="topbar-right">
        <div class="survey-progress-wrap">
          <div class="survey-progress-label">Step <span id="progressCurrent">1</span> of 4</div>
          <div class="survey-progress-bar"><div class="survey-progress-fill" id="progressFill" style="width:25%"></div></div>
        </div>
      </div>
    </header>

    <main class="content-panel">

      <!-- STEP 1 -->
      <div class="step active" id="step-0">
        <div class="step-header">
          <h2>Welcome to the Software Discovery Survey</h2>
          <p>This should take just a few minutes. Here's what to expect.</p>
        </div>
        <p style="font-size:0.9rem;color:var(--sb-text);line-height:1.75;margin-bottom:1.5rem">
          Rowe Casa Organics is building a full inventory of every app, program, and software tool used across the company.
          This helps our IT team manage licenses, improve security, and make sure everyone has what they need to do their job.<br/><br/>
          <strong>You don't need to be technical.</strong> Just list the tools you use at work — whether it's something you open in a browser like Asana, or a program installed on your computer like Adobe. Skip anything you're unsure about.
        </p>
        <div class="howto-steps">
          <div class="howto-step">
            <div class="howto-step-num">1</div>
            <div class="howto-step-text">
              <strong>Your Info</strong>
              <span>Just your name, email, and department — takes 30 seconds.</span>
            </div>
          </div>
          <div class="howto-step">
            <div class="howto-step-num">2</div>
            <div class="howto-step-text">
              <strong>Software Details</strong>
              <span>Add each app or program your team uses. Click <strong>Edit Details</strong> on any row to answer a few quick questions about that tool — who owns it, how critical it is, admin access, and more.</span>
            </div>
          </div>
          <div class="howto-step">
            <div class="howto-step-num">3</div>
            <div class="howto-step-text">
              <strong>Review & Submit</strong>
              <span>Check your entries and submit. That's it.</span>
            </div>
          </div>
        </div>
        <div style="display:flex;align-items:center;gap:1rem;flex-wrap:wrap">
          <button class="card-action" onclick="goTo(1)">Get Started →</button>
          <span style="font-size:0.8rem;color:var(--sb-muted)">Or use the sidebar to navigate between steps.</span>
        </div>
      </div>

      <!-- STEP 2 -->
      <div class="step" id="step-1">
        <div class="step-header">
          <h2>Your Info</h2>
          <p>Just the basics so we know who submitted this.</p>
        </div>
        <div class="info-grid">
          <div class="field-wrap">
            <label>Full Name</label>
            <input type="text" id="info_name" placeholder="Your full name"/>
          </div>
          <div class="field-wrap">
            <label>Work Email</label>
            <input type="email" id="info_email" placeholder="you@rowecasaorganics.com"/>
          </div>
          <div class="field-wrap" style="grid-column:1/-1">
            <label>Department</label>
            <select id="info_dept" style="max-width:260px">
              <option value="">— Select your department —</option>
              <option>Administration</option><option>Brand Experience</option>
              <option>Curing</option><option>Customer Care</option>
              <option>Customer Service</option><option>Facilities and Maintenance</option>
              <option>Finance</option><option>Human Resources</option>
              <option>Information Technology</option><option>Inventory</option>
              <option>Kitchen</option><option>Labeling</option>
              <option>Marketing</option><option>Operations</option>
              <option>Procurement</option><option>Production</option>
              <option>Project Management</option><option>Quality Control</option>
              <option>Research &amp; Development</option><option>Shipping</option>
              <option>Social Media</option><option>Strategy</option>
              <option>Wholesale</option>
            </select>
          </div>
        </div>
        <div style="margin-top:1.5rem">
          <button class="card-action" onclick="goToStep2()">Next: Software Details →</button>
        </div>
      </div>

      <!-- STEP 3 -->
      <div class="step" id="step-2">

        <div id="sw-summary-view">
          <div class="step-header">
            <h2>Software Details</h2>
            <p>List every app, program, or tool your team uses. Click <strong style="color:var(--brand-brown)">Edit Details</strong> on any row to fill in additional info about that app.</p>
          </div>

          <div style="margin-bottom:1.25rem">
            <button class="clear-btn" style="font-size:0.78rem" onclick="openModal('apps')">App Examples</button>
          </div>

          <div class="sw-table-wrap">
            <table class="sw-table">
              <thead>
                <tr>
                  <th style="width:26%">App / Software Name</th>
                  <th style="width:14%">Who Uses It</th>
                  <th style="width:13%">Criticality</th>
                  <th style="width:11%">Admin?</th>
                  <th style="width:13%">Owner</th>
                  <th style="width:23%">Actions</th>
                </tr>
              </thead>
              <tbody id="swTableBody">
                <tr><td colspan="5" style="text-align:center;color:var(--sb-muted);padding:2rem;font-size:0.85rem">No apps added yet — click the button below to get started.</td></tr>
              </tbody>
            </table>
          </div>

          <button class="add-sw-btn" onclick="addSoftware()">+ Add an app or software</button>

          <div style="margin-top:1.75rem;padding-top:1.25rem;border-top:1px solid var(--sb-sep)">
            <button class="card-action" onclick="goTo(3)">Review & Submit →</button>
          </div>
        </div>

        <!-- Details panel -->
        <div id="sw-details-view" class="details-panel">
          <button class="details-back" onclick="closeDetails()">← Back to Software List</button>
          <div class="details-context">
            <div class="details-context-name" id="details-app-name">—</div>
            <div class="details-context-sub">Fill in what you know — skip anything you're unsure about</div>
          </div>

          <div class="detail-q">
            <label>Who uses this tool?</label>
            <span class="q-sub">Select the option that best describes usage.</span>
            <div class="pill-group" id="d-who-pills">
              <button type="button" class="pill-btn" onclick="setPill('d_who',this,'Just me')">Just me</button>
              <button type="button" class="pill-btn" onclick="setPill('d_who',this,'My team')">My team</button>
              <button type="button" class="pill-btn" onclick="setPill('d_who',this,'Whole department')">Whole department</button>
            </div>
            <input type="hidden" id="d_who"/>
          </div>

          <div class="detail-q">
            <label>How critical is this tool to your job?</label>
            <span class="q-sub">1 = Nice to have &nbsp;·&nbsp; 5 = Can't do my job without it</span>
            <div class="sev-group">
              <button type="button" class="sev-btn" onclick="setSev(1)">1</button>
              <button type="button" class="sev-btn" onclick="setSev(2)">2</button>
              <button type="button" class="sev-btn" onclick="setSev(3)">3</button>
              <button type="button" class="sev-btn" onclick="setSev(4)">4</button>
              <button type="button" class="sev-btn" onclick="setSev(5)">5</button>
              <input type="hidden" id="d_severity"/>
            </div>
            <div class="sev-labels"><span>Not critical</span><span>Essential</span></div>
          </div>

          <div class="detail-q">
            <label>Do you have admin access?</label>
            <span class="q-sub">Admin = you can add/remove users or change account settings.</span>
            <div class="pill-group" id="d-admin-pills">
              <button type="button" class="pill-btn" onclick="setPill('d_admin',this,'Yes')">Yes</button>
              <button type="button" class="pill-btn" onclick="setPill('d_admin',this,'No')">No</button>
              <button type="button" class="pill-btn" onclick="setPill('d_admin',this,'Not sure')">Not sure</button>
            </div>
            <input type="hidden" id="d_admin"/>
          </div>

          <div class="detail-q">
            <label>Who owns or manages this application?</label>
            <span class="q-sub">The person responsible for the subscription or license.</span>
            <input type="text" class="detail-input" id="d_owner" placeholder="e.g. Philip Williams"/>
            <div style="margin-top:0.5rem">
              <button type="button" class="clear-btn" style="font-size:0.75rem" onclick="openModal('owners')">App Owner Examples</button>
            </div>
            <p class="skip-hint" style="margin-top:0.4rem">Skip if you don't know</p>
          </div>

          <div class="detail-q">
            <label>Any notes? <span style="font-weight:400;color:var(--sb-muted)">(optional)</span></label>
            <span class="q-sub">e.g. trial version, shared login, only used occasionally, pending cancellation</span>
            <textarea class="detail-textarea" id="d_notes" rows="3" placeholder="Optional notes..."></textarea>
          </div>

          <button class="card-action" onclick="saveDetails()">Save & Return to List ✓</button>
        </div>
      </div>

      <!-- STEP 4 -->
      <div class="step" id="step-3">
        <div class="step-header">
          <h2>Review & Submit</h2>
          <p>Check your details below, then hit submit.</p>
        </div>
        <div class="review-card">
          <h3>Your Info</h3>
          <div id="reviewSummary"></div>
        </div>
        <div class="review-card">
          <h3>Software Entries <span id="reviewCount" style="font-weight:400;text-transform:none;letter-spacing:0;font-size:0.8rem"></span></h3>
          <div id="reviewSwList"></div>
        </div>
        <div style="display:flex;align-items:center;gap:1rem;flex-wrap:wrap;margin-top:0.5rem">
          <button class="card-action" id="submitBtn" onclick="submitSurvey()">Submit Survey →</button>
          <div id="submitStatus" class="contact-status"></div>
        </div>
      </div>

    </main>
  </div>
</div>

<!-- Modal -->
<div class="modal-overlay hidden" id="examplesModal">
  <div class="modal-box">
    <h3>Reference</h3>
    <div class="modal-tabs">
      <button class="modal-tab active" onclick="switchTab('apps')">App Examples</button>
      <button class="modal-tab"        onclick="switchTab('owners')">App Owner Examples</button>
    </div>
    <div class="modal-tab-content active" id="tab-apps"></div>
    <div class="modal-tab-content"        id="tab-owners"></div>
    <button class="modal-close" onclick="closeModal()">Got it</button>
  </div>
</div>

<!-- Firebase -->
<script type="module">
  import { initializeApp, getApps, getApp }         from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
  import { getAuth, onAuthStateChanged, signOut }    from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
  import { getFirestore, collection, addDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

  const cfg = {
    apiKey:"AIzaSyBRKBzxTYzBnBHo-YY8fSxTSSkM3uyujmc",
    authDomain:"ithelpsite-4ec53.firebaseapp.com",
    projectId:"ithelpsite-4ec53",
    storageBucket:"ithelpsite-4ec53.firebasestorage.app",
    messagingSenderId:"893459212285",
    appId:"1:893459212285:web:194adf30886cbb28c21b94"
  };
  const fbApp = getApps().length ? getApp() : initializeApp(cfg);
  const auth  = getAuth(fbApp);
  const db    = getFirestore(fbApp);

  onAuthStateChanged(auth, user => {
    if (!user || !user.email.endsWith('@rowecasaorganics.com')) {
      signOut(auth).finally(() => window.location.replace('../login.html'));
      return;
    }
    window._currentUser = user;
  });

  window.saveSubmission = async function(data) {
    if (!window._currentUser) {
      await new Promise(resolve => {
        const u = onAuthStateChanged(auth, usr => { if(usr){window._currentUser=usr;u();resolve();} });
        setTimeout(resolve, 5000);
      });
    }
    if (!window._currentUser) return false;
    try {
      await addDoc(collection(db,'submissions'), {
        ...data, uid: window._currentUser.uid,
        userEmail: window._currentUser.email, submittedAt: serverTimestamp()
      });
      return true;
    } catch(e) { console.error(e); return false; }
  };
</script>

<script>
// ── Constants ───────────────────────────────────────────────
const SHEET_ENDPOINT = 'https://script.google.com/macros/s/AKfycbxeP-Asvk9kgGx_oz4jMWYOBldaPLM8Tm6S2XfXOfDRat-3KX1UfVXYzEju2Dc7nDwBGg/exec';

const APP_EXAMPLES = {
  'Communication & Calling':   ['Gmail','Slack','Zoom','RingCentral','Dialpad','Google Meet','Loom','Microsoft Teams','Outlook'],
  'Project Management':        ['Asana','Trello','Notion','TickTick','Smartsheet','ClickUp'],
  'Design & Creative':         ['Adobe','Canva','CapCut','Superside','Pantone Connect','BeFunky Photo Editor','SmartDraw','SlidesAI.io'],
  'E-commerce & Fulfillment':  ['Shopify','Shop (Shopify)','Shopify Partners','ShipStation','Katana','Okendo','Dynamatic','Replo','Better Reports','Lifetimely'],
  'Marketing & Social':        ['Klaviyo','Sprout Social','Semrush','Manychat','Facebook','Instagram','TikTok for Business','Pinterest','YouTube','Buffer'],
  'Wholesale & Retail':        ['Faire','RangeMe'],
  'Finance & Procurement':     ['Global Industrial','Expedia Group','vevor'],
  'HR & Recruiting':           ['BambooHR','Glassdoor','iHire','ZipRecruiter','Virtualstaff','Upwork Calendar Service','Shift Scheduler'],
  'Analytics & Reporting':     ['Power BI Desktop','Looker Studio','Geckoboard','Databox','ChartExpo','Better Reports','Lifetimely'],
  'AI & Automation':           ['ChatGPT / OpenAI','Claude','Zapier','Zapier Bot','Julius AI','KLINGAI','Otter.ai','Read AI','QuillBot'],
  'IT, Dev & Security':        ['GitHub','Cloudflare Dashboard','Fly.io','GoDaddy','Postman','manage.auth0.com','Synology Account','Pixel Labs / Helium 10'],
  'Documents, Forms & Labels': ['DocHub','Jotform','Grammarly','Lumin PDF','Scribe','Avery Design & Print Online','Foxy Labels','Labelmaker','Simplebooklet','WiseStamp'],
  'Meetings & Events':         ['Calendly','Livestorm','Pixieset','Otter.ai','Read AI'],
  'Other':                     ['Alignable','Amazon','MemberSpace','Dropbox','Accessibility Tracker','AI KPI Tracker','Chatbot App','Schedule Email Reports'],
};

const KNOWN_OWNERS = [
  { name:'Philip Williams', apps:'Shopify, Shopify Partners, Gorgias, ShipStation, Katana, Cloudflare Dashboard, Google Workspace' },
  { name:'Chris Paulene',   apps:'BambooHR' },
  { name:'Grant / Heidi',   apps:'Asana' },
  { name:'Kaylee Pope',     apps:'Canva' },
];

// ── State ───────────────────────────────────────────────────
var softwareList = [];
var editingIdx   = null;

// ── Navigation ──────────────────────────────────────────────
function goTo(n) {
  if (n === 3) buildReview();
  var steps = document.querySelectorAll('.step');
  var btns  = document.querySelectorAll('.step-nav-btn');
  for (var i = 0; i < steps.length; i++) steps[i].classList.toggle('active', i === n);
  for (var i = 0; i < btns.length;  i++) btns[i].classList.toggle('active',  i === n);
  document.getElementById('progressCurrent').textContent = n + 1;
  document.getElementById('progressFill').style.width = ((n + 1) / 4 * 100) + '%';
  window.scrollTo(0, 0);
}

function goToStep2() {
  var name  = document.getElementById('info_name').value.trim();
  var email = document.getElementById('info_email').value.trim();
  var dept  = document.getElementById('info_dept').value;
  if (!name || !email || !dept) {
    alert('Please fill in your name, email, and department before continuing.');
    return;
  }
  goTo(2);
}

// ── Software table ──────────────────────────────────────────
function addSoftware() {
  softwareList.push({ name:'', severity:'', admin:'', owner:'', who:'', notes:'', detailsFilled:false });
  renderTable();
  setTimeout(function() {
    var inputs = document.querySelectorAll('.sw-name-input');
    if (inputs.length) inputs[inputs.length - 1].focus();
  }, 50);
}

function removeSoftware(idx) {
  softwareList.splice(idx, 1);
  renderTable();
}

function editRow(idx) {
  openDetails(idx);
}

function renderTable() {
  var tbody = document.getElementById('swTableBody');
  var thead = document.querySelector('.sw-table thead');
  if (!softwareList.length) {
    thead.style.display = 'none';
    tbody.innerHTML = '<tr><td style="text-align:center;color:var(--sb-muted);padding:2rem;font-size:0.85rem">No apps added yet — click the button below to get started.</td></tr>';
    return;
  }
  thead.style.display = '';

  var html = '';
  for (var i = 0; i < softwareList.length; i++) {
    var sw   = softwareList[i];
    var dots = '';
    for (var d = 1; d <= 5; d++) {
      dots += '<div class="sev-dot' + (sw.severity && d <= parseInt(sw.severity) ? ' on' : '') + '"></div>';
    }
    var adm = sw.admin === 'Yes' ? '<span class="pill-sm pill-yes">Yes</span>'
            : sw.admin === 'No'  ? '<span class="pill-sm pill-no">No</span>'
            : sw.admin           ? '<span class="pill-sm pill-na">' + esc(sw.admin) + '</span>'
            : '<span style="color:var(--sb-muted);font-size:0.75rem">—</span>';
    var whoDisplay = sw.who ? '<span style="font-size:0.75rem;color:var(--sb-text)">' + esc(sw.who) + '</span>'
                            : '<span style="color:var(--sb-muted);font-size:0.75rem">—</span>';
    var btnClass = sw.detailsFilled ? 'edit-btn done' : 'edit-btn';
    var btnLabel = sw.detailsFilled ? '✓ Edited'      : 'Edit Details';

    html += '<tr>'
      + '<td><input class="sw-name-input" type="text" placeholder="App or software name" data-idx="' + i + '" value="' + esc(sw.name) + '"/></td>'
      + '<td>' + whoDisplay + '</td>'
      + '<td><div class="sev-dots">' + dots + '</div></td>'
      + '<td>' + adm + '</td>'
      + '<td style="color:var(--sb-muted);font-size:0.78rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">' + esc(sw.owner || '—') + '</td>'
      + '<td style="text-align:center;white-space:nowrap">'
      +   '<button class="' + btnClass + '" data-edit="' + i + '">' + btnLabel + '</button>'
      +   '&nbsp;&nbsp;<button class="remove-btn" data-remove="' + i + '">✕</button>'
      + '</td>'
      + '</tr>';
  }
  tbody.innerHTML = html;

  // Attach events via delegation-safe direct binding after render
  var nameInputs = tbody.querySelectorAll('.sw-name-input');
  for (var j = 0; j < nameInputs.length; j++) {
    (function(el) {
      el.addEventListener('input', function() {
        softwareList[parseInt(el.dataset.idx)].name = el.value;
      });
    })(nameInputs[j]);
  }

  var editBtns = tbody.querySelectorAll('[data-edit]');
  for (var j = 0; j < editBtns.length; j++) {
    (function(el) {
      el.addEventListener('click', function() {
        openDetails(parseInt(el.dataset.edit));
      });
    })(editBtns[j]);
  }

  var removeBtns = tbody.querySelectorAll('[data-remove]');
  for (var j = 0; j < removeBtns.length; j++) {
    (function(el) {
      el.addEventListener('click', function() {
        removeSoftware(parseInt(el.dataset.remove));
      });
    })(removeBtns[j]);
  }
}

// ── Details panel ───────────────────────────────────────────
function openDetails(idx) {
  editingIdx = idx;
  var sw = softwareList[idx];
  document.getElementById('details-app-name').textContent = sw.name || 'Unnamed App';
  restorePills('d-who-pills',   'd_who',   sw.who);
  restorePills('d-admin-pills', 'd_admin', sw.admin);
  restoreSev(sw.severity);
  document.getElementById('d_owner').value = sw.owner || '';
  document.getElementById('d_notes').value = sw.notes || '';
  document.getElementById('sw-summary-view').style.display = 'none';
  document.getElementById('sw-details-view').classList.add('active');
  window.scrollTo(0, 0);
}

function closeDetails() {
  document.getElementById('sw-summary-view').style.display = '';
  document.getElementById('sw-details-view').classList.remove('active');
  editingIdx = null;
}

function saveDetails() {
  if (editingIdx === null) return;
  var sw      = softwareList[editingIdx];
  sw.who      = document.getElementById('d_who').value;
  sw.severity = document.getElementById('d_severity').value;
  sw.admin    = document.getElementById('d_admin').value;
  sw.owner    = document.getElementById('d_owner').value;
  sw.notes    = document.getElementById('d_notes').value;
  sw.detailsFilled = !!(sw.who || sw.severity || sw.admin || sw.owner);
  renderTable();
  closeDetails();
}

// ── Pill / sev helpers ──────────────────────────────────────
function setPill(fid, btn, val) {
  var group = btn.closest('.pill-group').querySelectorAll('.pill-btn');
  for (var i = 0; i < group.length; i++) group[i].classList.remove('selected');
  btn.classList.add('selected');
  document.getElementById(fid).value = val;
}

function setSev(val) {
  var btns = document.querySelectorAll('.sev-btn');
  for (var i = 0; i < btns.length; i++) btns[i].classList.toggle('selected', i < val);
  document.getElementById('d_severity').value = val;
}

function restorePills(gid, fid, val) {
  document.getElementById(fid).value = val || '';
  var btns = document.getElementById(gid).querySelectorAll('.pill-btn');
  for (var i = 0; i < btns.length; i++) {
    btns[i].classList.toggle('selected', btns[i].textContent.trim() === val);
  }
}

function restoreSev(val) {
  document.getElementById('d_severity').value = val || '';
  var btns = document.querySelectorAll('.sev-btn');
  for (var i = 0; i < btns.length; i++) {
    btns[i].classList.toggle('selected', !!val && i < parseInt(val));
  }
}

// ── Review ──────────────────────────────────────────────────
function buildReview() {
  var name  = document.getElementById('info_name').value;
  var email = document.getElementById('info_email').value;
  var dept  = document.getElementById('info_dept').value;
  var date  = new Date().toLocaleDateString('en-US', { month:'long', day:'numeric', year:'numeric' });
  document.getElementById('reviewSummary').innerHTML =
    '<div class="review-row"><span>Name</span><strong>'       + esc(name  || '—') + '</strong></div>' +
    '<div class="review-row"><span>Email</span><strong>'      + esc(email || '—') + '</strong></div>' +
    '<div class="review-row"><span>Department</span><strong>' + esc(dept  || '—') + '</strong></div>' +
    '<div class="review-row"><span>Date</span><strong>'       + date              + '</strong></div>';

  var valid = softwareList.filter(function(s) { return s.name.trim(); });
  document.getElementById('reviewCount').textContent = '(' + valid.length + ' entr' + (valid.length === 1 ? 'y' : 'ies') + ')';

  if (!valid.length) {
    document.getElementById('reviewSwList').innerHTML = '<p style="color:var(--sb-muted);font-size:0.85rem">No software entries added.</p>';
    return;
  }
  var html = '';
  for (var i = 0; i < valid.length; i++) {
    var s    = valid[i];
    var meta = [
      s.severity ? 'Criticality: ' + s.severity + '/5' : '',
      s.admin    ? 'Admin: '       + s.admin            : '',
      s.owner    ? 'Owner: '       + s.owner            : '',
      s.who      ? 'Used by: '     + s.who              : '',
    ].filter(Boolean).join(' · ') || 'No details added';
    html += '<div class="review-sw-item"><strong>' + esc(s.name) + '</strong><span>' + esc(meta) + '</span></div>';
  }
  document.getElementById('reviewSwList').innerHTML = html;
}

// ── Modal ───────────────────────────────────────────────────
function buildModal() {
  var appsHtml = '';
  var cats = Object.keys(APP_EXAMPLES);
  for (var i = 0; i < cats.length; i++) {
    var apps = APP_EXAMPLES[cats[i]];
    var tags = '';
    for (var j = 0; j < apps.length; j++) tags += '<span class="modal-app-tag">' + apps[j] + '</span>';
    appsHtml += '<div class="modal-category"><h4>' + cats[i] + '</h4><div class="modal-apps">' + tags + '</div></div>';
  }
  document.getElementById('tab-apps').innerHTML = appsHtml;

  var ownerRows = '';
  for (var i = 0; i < KNOWN_OWNERS.length; i++) {
    ownerRows += '<tr><td style="font-weight:700">' + esc(KNOWN_OWNERS[i].name) + '</td>'
               + '<td style="color:var(--sb-muted);font-size:0.78rem">' + esc(KNOWN_OWNERS[i].apps) + '</td></tr>';
  }
  document.getElementById('tab-owners').innerHTML =
    '<p style="font-size:0.8rem;color:var(--sb-muted);margin-bottom:1rem;line-height:1.5">Known owners/admins for common RCO apps. Use this as a reference when filling in the owner field.</p>' +
    '<table class="owners-table"><thead><tr><th>Person</th><th>Apps They Own / Manage</th></tr></thead><tbody>' + ownerRows + '</tbody></table>';
}

function openModal(tab) {
  buildModal();
  switchTab(tab || 'apps');
  document.getElementById('examplesModal').classList.remove('hidden');
}

function closeModal() {
  document.getElementById('examplesModal').classList.add('hidden');
}

function switchTab(tab) {
  document.getElementById('tab-apps').classList.toggle('active',    tab === 'apps');
  document.getElementById('tab-owners').classList.toggle('active',  tab === 'owners');
  var tabs = document.querySelectorAll('.modal-tab');
  tabs[0].classList.toggle('active', tab === 'apps');
  tabs[1].classList.toggle('active', tab === 'owners');
}

document.getElementById('examplesModal').addEventListener('click', function(e) {
  if (e.target === document.getElementById('examplesModal')) closeModal();
});

// ── Init ─────────────────────────────────────────────────────
renderTable();

// ── Submit ──────────────────────────────────────────────────
async function submitSurvey() {
  var btn   = document.getElementById('submitBtn');
  var stat  = document.getElementById('submitStatus');
  var name  = document.getElementById('info_name').value.trim();
  var email = document.getElementById('info_email').value.trim();
  var dept  = document.getElementById('info_dept').value;
  if (!name || !email || !dept) {
    stat.textContent = 'Please go back and fill in your name, email, and department.';
    stat.className   = 'contact-status error';
    return;
  }
  btn.textContent = 'Submitting…';
  btn.disabled    = true;

  var payload = {
    info_name: name, info_email: email, info_dept: dept,
    info_date: new Date().toLocaleDateString('en-US'),
    submitted_at: new Date().toISOString()
  };
  var valid = softwareList.filter(function(s) { return s.name.trim(); });
  for (var i = 0; i < valid.length; i++) {
    var sw = valid[i];
    var b  = 'app_r' + i;
    payload[b + '_name']     = sw.name;
    payload[b + '_severity'] = sw.severity;
    payload[b + '_who']      = sw.who;
    payload[b + '_admin']    = sw.admin;
    payload[b + '_owner']    = sw.owner;
    payload[b + '_notes']    = sw.notes;
  }

  fetch(SHEET_ENDPOINT, {
    method: 'POST', mode: 'no-cors',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  }).catch(function() {});

  var saved = window.saveSubmission
    ? await window.saveSubmission({ title: 'Technology & Application Discovery Survey', dept: dept, url: 'surveys/tech-discovery.html' })
    : true;

  if (saved) {
    stat.textContent = '✅ Survey submitted! Redirecting you back to the portal…';
    stat.className   = 'contact-status success';
    btn.textContent  = 'Submitted ✓';
    setTimeout(function() { window.location.href = '../index.html'; }, 2500);
  } else {
    stat.textContent = '❌ Submission failed. Please try again or contact itsupport@rowecasaorganics.com.';
    stat.className   = 'contact-status error';
    btn.textContent  = 'Submit Survey →';
    btn.disabled     = false;
  }
}

// ── Helpers ─────────────────────────────────────────────────
function esc(s) {
  return String(s || '').replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}
</script>
</body>
</html>
