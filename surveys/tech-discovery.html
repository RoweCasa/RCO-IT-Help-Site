<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Technology & Application Discovery Survey — RCO IT</title>
  <link rel="stylesheet" href="../styles.css"/>
  <style>
    /* ── Conversational tool card ── */
    .tool-card {
      background: var(--sidebar-bg);
      border: 1.5px solid var(--sb-border);
      border-radius: 14px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      position: relative;
      transition: border-color 0.18s;
    }
    .tool-card:hover { border-color: var(--brand-hover-border); }

    .tool-card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1.1rem;
    }

    .tool-card-num {
      font-size: 0.72rem;
      font-weight: 800;
      color: var(--sb-muted);
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .tool-card-remove {
      background: none;
      border: none;
      color: var(--sb-muted);
      font-size: 0.8rem;
      cursor: pointer;
      font-family: inherit;
      font-weight: 600;
      padding: 0;
      transition: color 0.15s;
    }
    .tool-card-remove:hover { color: #c0392b; }

    .tool-question {
      margin-bottom: 1rem;
    }

    .tool-question label {
      display: block;
      font-size: 0.85rem;
      font-weight: 700;
      color: var(--sb-text);
      margin-bottom: 0.35rem;
    }

    .tool-question .q-hint {
      font-size: 0.75rem;
      color: var(--sb-muted);
      font-weight: 400;
      margin-bottom: 0.4rem;
      display: block;
    }

    .tool-question input,
    .tool-question textarea,
    .tool-question select {
      width: 100%;
      background: var(--panel-bg);
      border: 1.5px solid var(--sb-border);
      border-radius: 9px;
      padding: 0.6rem 0.85rem;
      font-size: 0.875rem;
      font-family: inherit;
      color: var(--sb-text);
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s;
      resize: vertical;
    }

    .tool-question input:focus,
    .tool-question textarea:focus,
    .tool-question select:focus {
      border-color: var(--brand-hover-border);
      box-shadow: 0 0 0 3px rgba(189,153,121,0.15);
    }

    /* who-uses pill buttons */
    .who-pills {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      margin-top: 0.25rem;
    }

    .who-pill {
      padding: 0.38rem 0.9rem;
      border-radius: 999px;
      border: 1.5px solid var(--sb-border);
      background: var(--panel-bg);
      color: var(--sb-text);
      font-size: 0.8rem;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.15s;
    }

    .who-pill:hover { border-color: var(--brand-hover-border); }

    .who-pill.selected {
      background: var(--brand-grad);
      border-color: var(--brand-brown);
      color: #fff;
    }

    .tool-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.85rem;
    }

    @media (max-width: 600px) { .tool-grid { grid-template-columns: 1fr; } }

    .add-tool-btn {
      width: 100%;
      padding: 0.85rem;
      border: 2px dashed var(--sb-border);
      border-radius: 14px;
      background: none;
      color: var(--sb-muted);
      font-size: 0.875rem;
      font-weight: 700;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.18s;
      margin-top: 0.5rem;
    }
    .add-tool-btn:hover {
      border-color: var(--brand-hover-border);
      color: var(--brand-brown);
      background: var(--brand-soft);
    }

    .section-label-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
      background: var(--brand-soft);
      border: 1px solid var(--brand-hover-border);
      color: var(--brand-brown);
      font-size: 0.75rem;
      font-weight: 700;
      padding: 0.25rem 0.7rem;
      border-radius: 999px;
      margin-bottom: 1rem;
    }

    .empty-section-msg {
      text-align: center;
      padding: 2rem 1rem;
      color: var(--sb-muted);
      font-size: 0.875rem;
      border: 1.5px dashed var(--sb-border);
      border-radius: 14px;
      margin-bottom: 1rem;
    }
    .empty-section-msg strong { display: block; margin-bottom: 0.3rem; color: var(--sb-text); }
  </style>
</head>
<body>

  <div class="app-shell">

    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="sidebar-logo-wrap">
        <img src="../logo.png" alt="Rowe Casa Organics" class="sidebar-logo"/>
      </div>
      <div class="sidebar-divider"></div>
      <nav class="sidebar-nav" id="stepNav"></nav>
      <div class="sidebar-footer">
        <div class="sidebar-divider"></div>
        <button class="contact-btn" onclick="window.location.href='../index.html'">
          ← Back to Portal
        </button>
        <div class="portal-label">RCO IT Help Site</div>
        <div class="portal-sub">@rowecasaorganics.com</div>
      </div>
    </aside>

    <!-- MAIN WRAP -->
    <div class="main-wrap">
      <header class="topbar">
        <div class="topbar-left">
          <div class="topbar-title">Technology & Application Discovery Survey</div>
          <div class="topbar-desc">Help us track every app and software your team uses — web, desktop, or licensed.</div>
        </div>
        <div class="topbar-right">
          <div class="survey-progress-wrap">
            <div class="survey-progress-label">Step <span id="progressCurrent">1</span> of <span id="progressTotal">—</span></div>
            <div class="survey-progress-bar"><div class="survey-progress-fill" id="progressFill"></div></div>
          </div>
        </div>
      </header>

      <main class="content-panel">
        <div id="surveyBody"></div>
        <div class="survey-nav">
          <button class="clear-btn" id="prevBtn" onclick="surveyNav(-1)">← Previous</button>
          <button class="card-action" id="nextBtn" onclick="surveyNav(1)">Next →</button>
        </div>
      </main>
    </div>
  </div>

  <!-- Google Sheets endpoint -->
  <script>
    const SHEET_ENDPOINT = 'https://script.google.com/macros/s/AKfycbxeP-Asvk9kgGx_oz4jMWYOBldaPLM8Tm6S2XfXOfDRat-3KX1UfVXYzEju2Dc7nDwBGg/exec';
  </script>

  <!-- Firebase module -->
  <script type="module">
    import { initializeApp, getApps, getApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFirestore, collection, addDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    const FIREBASE_CONFIG = {
      apiKey:            "AIzaSyBRKBzxTYzBnBHo-YY8fSxTSSkM3uyujmc",
      authDomain:        "ithelpsite-4ec53.firebaseapp.com",
      projectId:         "ithelpsite-4ec53",
      storageBucket:     "ithelpsite-4ec53.firebasestorage.app",
      messagingSenderId: "893459212285",
      appId:             "1:893459212285:web:194adf30886cbb28c21b94",
      measurementId:     "G-H6WM1LWQ4V"
    };

    const app  = getApps().length ? getApp() : initializeApp(FIREBASE_CONFIG);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    onAuthStateChanged(auth, user => {
      if (!user || !user.email.endsWith('@rowecasaorganics.com')) {
        signOut(auth).finally(() => window.location.replace('../login.html'));
        return;
      }
      window._currentUser = user;
    });

    window.saveSubmission = async function(data) {
      if (!window._currentUser) {
        await new Promise(resolve => {
          const unsub = onAuthStateChanged(auth, user => {
            if (user) { window._currentUser = user; unsub(); resolve(); }
          });
          setTimeout(resolve, 5000);
        });
      }
      if (!window._currentUser) return false;
      try {
        await addDoc(collection(db, 'submissions'), {
          ...data,
          uid:         window._currentUser.uid,
          userEmail:   window._currentUser.email,
          submittedAt: serverTimestamp(),
        });
        return true;
      } catch (err) {
        console.error('Firestore save failed:', err);
        return false;
      }
    };
  </script>

  <!-- Main survey script -->
  <script>
    const DEPARTMENTS = [
      'Administration','Brand Experience','Curing','Customer Care',
      'Customer Service','Facilities and Maintenance','Finance',
      'Human Resources','Information Technology','Inventory','Kitchen',
      'Labeling','Marketing','Operations','Procurement','Production',
      'Project Management','Quality Control','Research & Development',
      'Shipping','Social Media','Strategy','Wholesale',
    ];

    const DEPT_SECTIONS = {
      'Administration':             ['comm','prod','pm','finance','hr','other'],
      'Brand Experience':           ['comm','prod','pm','marketing','design','other'],
      'Curing':                     ['comm','prod','ops','other'],
      'Customer Care':              ['comm','prod','pm','crm','other'],
      'Customer Service':           ['comm','prod','pm','crm','other'],
      'Facilities and Maintenance': ['comm','prod','ops','other'],
      'Finance':                    ['comm','prod','pm','finance','other'],
      'Human Resources':            ['comm','prod','pm','hr','other'],
      'Information Technology':     ['comm','prod','pm','it','ops','other'],
      'Inventory':                  ['comm','prod','ops','other'],
      'Kitchen':                    ['comm','prod','ops','other'],
      'Labeling':                   ['comm','prod','ops','other'],
      'Marketing':                  ['comm','prod','pm','marketing','design','other'],
      'Operations':                 ['comm','prod','pm','ops','finance','other'],
      'Procurement':                ['comm','prod','pm','finance','ops','other'],
      'Production':                 ['comm','prod','pm','ops','other'],
      'Project Management':         ['comm','prod','pm','other'],
      'Quality Control':            ['comm','prod','ops','other'],
      'Research & Development':     ['comm','prod','pm','design','other'],
      'Shipping':                   ['comm','prod','ops','other'],
      'Social Media':               ['comm','prod','marketing','design','other'],
      'Strategy':                   ['comm','prod','pm','finance','other'],
      'Wholesale':                  ['comm','prod','pm','crm','finance','other'],
    };

    const ALL_TOOL_SECTIONS = {
      comm:     { title: 'Communication',               examples: 'Gmail, Slack, Microsoft Teams, Zoom, Outlook, any phone or messaging apps' },
      prod:     { title: 'Productivity & File Storage', examples: 'Google Drive, Dropbox, Microsoft 365, Notion, OneDrive, Box' },
      pm:       { title: 'Project Management',          examples: 'Asana, Monday.com, Trello, ClickUp, Basecamp, Smartsheet' },
      hr:       { title: 'HR & People',                 examples: 'BambooHR, ADP, Gusto, Rippling, any payroll, onboarding, or hiring software' },
      finance:  { title: 'Finance & Accounting',        examples: 'QuickBooks, Expensify, Bill.com, NetSuite, any invoicing or expense software' },
      crm:      { title: 'Sales & Customer Tools',      examples: 'Salesforce, HubSpot, any software for tracking customers, orders, or sales' },
      marketing:{ title: 'Marketing',                   examples: 'Mailchimp, Klaviyo, Hootsuite, Google Analytics, Meta Ads, any marketing platforms' },
      it:       { title: 'IT & Security',               examples: 'Password managers (1Password, LastPass), VPN, antivirus, any IT or security software' },
      design:   { title: 'Design & Creative',           examples: 'Adobe Acrobat, Adobe Creative Cloud, Canva, Figma, any design or video/photo editing apps' },
      ops:      { title: 'Operations & Logistics',      examples: 'ShipStation, any inventory, warehouse, shipping, or production software' },
      other:    { title: 'Anything Else',               examples: 'Any software not covered above — including apps installed directly on your computer, browser extensions, or tools you only use occasionally' },
    };

    // ── State ──────────────────────────────────────────────────────
    let currentStep    = 0;
    let surveyData     = {};  // info fields
    let toolData       = {};  // { sectionId: [ {name, who, login, notes}, ... ] }
    let activeSections = [];

    // ── Section builder ────────────────────────────────────────────
    function buildSections(dept) {
      const ids = DEPT_SECTIONS[dept] || ['comm','prod','pm','other'];
      const sections = [{ id: 'info', title: 'About You', type: 'info' }];
      ids.forEach(id => sections.push({
        id, type: 'tools',
        title:   ALL_TOOL_SECTIONS[id].title,
        emoji:   ALL_TOOL_SECTIONS[id].emoji,
        examples:ALL_TOOL_SECTIONS[id].examples,
      }));
      sections.push(
        { id: 'comments', title: 'Anything Else?',  type: 'comments' },
        { id: 'review',   title: 'Review & Submit', type: 'review'   }
      );
      return sections;
    }

    // ── Sidebar step nav ───────────────────────────────────────────
    function buildStepNav() {
      const nav = document.getElementById('stepNav');
      nav.innerHTML = '';
      activeSections.forEach((s, i) => {
        const btn = document.createElement('button');
        btn.className = 'nav-btn step-nav-btn'
          + (i === currentStep ? ' active' : '')
          + (i < currentStep  ? ' done'   : '');
        btn.innerHTML = `<span class="step-num">${i + 1}</span> ${s.title}`;
        btn.onclick = () => { saveStep(); goToStep(i); };
        nav.appendChild(btn);
      });
      document.getElementById('progressTotal').textContent = activeSections.length;
    }

    function updateStepNav() {
      document.querySelectorAll('.step-nav-btn').forEach((b, i) => {
        b.classList.toggle('active', i === currentStep);
        b.classList.toggle('done',   i < currentStep);
      });
    }

    // ── Tool card HTML ─────────────────────────────────────────────
    function toolCardHTML(sid, idx, tool) {
      const who   = tool.who   || '';
      const whoOptions = ['Just me', 'My team', 'Whole department'];
      return `<div class="tool-card" data-sid="${sid}" data-idx="${idx}">
        <div class="tool-card-header">
          <span class="tool-card-num">Tool ${idx + 1}</span>
          ${idx > 0 ? `<button class="tool-card-remove" onclick="removeTool('${sid}', ${idx})">✕ Remove</button>` : ''}
        </div>

        <div class="tool-question">
          <label>What's the name of the tool or app?</label>
          <span class="q-hint">Just the name is fine — e.g. "Gmail" or "Slack"</span>
          <input type="text" placeholder="Tool or app name" data-field="name"
            value="${escHtml(tool.name || '')}"/>
        </div>

        <div class="tool-question">
          <label>Who uses this tool?</label>
          <span class="q-hint">Select all that apply</span>
          <div class="who-pills">
            ${whoOptions.map(opt => `
              <button type="button" class="who-pill ${who === opt ? 'selected' : ''}"
                onclick="selectWho(this, '${sid}', ${idx}, '${opt}')">${opt}</button>
            `).join('')}
          </div>
          <input type="hidden" data-field="who" value="${escHtml(who)}"/>
        </div>

        <div class="tool-grid">
          <div class="tool-question">
            <label>Login or account email <span style="color:var(--sb-muted);font-weight:400">(optional)</span></label>
            <span class="q-hint">The email address used to log in, if known</span>
            <input type="text" placeholder="e.g. team@rowecasaorganics.com" data-field="login"
              value="${escHtml(tool.login || '')}"/>
          </div>
          <div class="tool-question">
            <label>Anything else we should know? <span style="color:var(--sb-muted);font-weight:400">(optional)</span></label>
            <span class="q-hint">e.g. paid subscription, trial, rarely used</span>
            <input type="text" placeholder="Optional notes" data-field="notes"
              value="${escHtml(tool.notes || '')}"/>
          </div>
        </div>
      </div>`;
    }

    function escHtml(str) {
      return String(str).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    // ── Who pill selection ─────────────────────────────────────────
    function selectWho(btn, sid, idx, val) {
      const card = btn.closest('.tool-card');
      card.querySelectorAll('.who-pill').forEach(p => p.classList.remove('selected'));
      btn.classList.add('selected');
      card.querySelector('[data-field="who"]').value = val;
      if (!toolData[sid]) toolData[sid] = [];
      if (!toolData[sid][idx]) toolData[sid][idx] = {};
      toolData[sid][idx].who = val;
    }

    // ── Add / remove tool ──────────────────────────────────────────
    function addTool(sid) {
      if (!toolData[sid]) toolData[sid] = [{}];
      else toolData[sid].push({});
      rerenderTools(sid);
    }

    function removeTool(sid, idx) {
      toolData[sid].splice(idx, 1);
      rerenderTools(sid);
    }

    function rerenderTools(sid) {
      const wrap = document.getElementById('tools-wrap-' + sid);
      if (!wrap) return;
      const tools = toolData[sid] || [{}];
      wrap.innerHTML = tools.map((t, i) => toolCardHTML(sid, i, t)).join('');
    }

    // ── Render step ────────────────────────────────────────────────
    function renderStep(idx) {
      const sec   = activeSections[idx];
      const total = activeSections.length;
      const body  = document.getElementById('surveyBody');

      document.getElementById('progressCurrent').textContent = idx + 1;
      document.getElementById('progressTotal').textContent   = total;
      document.getElementById('progressFill').style.width    = ((idx + 1) / total * 100) + '%';
      document.getElementById('prevBtn').style.visibility    = idx === 0 ? 'hidden' : 'visible';
      document.getElementById('nextBtn').textContent         = idx === total - 1 ? 'Submit Survey ✓' : 'Next →';

      updateStepNav();

      if (sec.type === 'info') {
        body.innerHTML = `<div class="survey-page">
          <p class="survey-instruction">Let's start with a little info about you. This helps us know who submitted the survey.</p>
          <p class="survey-instruction" style="margin-top:0.75rem"><strong>What we're collecting:</strong> A list of every app and software your team uses — this includes web apps like Asana or Google Drive, desktop apps like Adobe Acrobat or QuickBooks, and anything else that's licensed or regularly used. If you use it for work, we want to know about it.</p>
          <div class="info-grid">
            <div class="contact-field">
              <label>What's your full name?</label>
              <input class="ti" type="text" data-key="info_name" placeholder="Your full name" value="${escHtml(surveyData.info_name||'')}"/>
            </div>
            <div class="contact-field">
              <label>What's your job title?</label>
              <input class="ti" type="text" data-key="info_title" placeholder="Your job title" value="${escHtml(surveyData.info_title||'')}"/>
            </div>
            <div class="contact-field">
              <label>Which department are you in?</label>
              <select class="ti" data-key="info_dept">
                <option value="">— Select your department —</option>
                ${DEPARTMENTS.map(d => `<option value="${d}" ${surveyData.info_dept === d ? 'selected' : ''}>${d}</option>`).join('')}
              </select>
            </div>
            <div class="contact-field">
              <label>What's your work email?</label>
              <input class="ti" type="email" data-key="info_email" placeholder="yourname@rowecasaorganics.com" value="${escHtml(surveyData.info_email||'')}"/>
            </div>
            <div class="contact-field">
              <label>Today's date</label>
              <input class="ti" type="date" data-key="info_date" value="${escHtml(surveyData.info_date||'')}"/>
            </div>
          </div>
        </div>`;

      } else if (sec.type === 'tools') {
        if (!toolData[sec.id]) toolData[sec.id] = [];
        const tools = toolData[sec.id];
        body.innerHTML = `<div class="survey-page">
          <h2 style="font-size:1.8rem;font-weight:800;color:var(--sb-text);letter-spacing:-0.02em;margin-bottom:0.5rem">${sec.title}</h2>
          <p class="survey-instruction">
            Think about every app or software your team uses for <strong>${sec.title.toLowerCase()}</strong> — whether it's a website you log into, a program installed on your computer, or something you have a license for.<br/><br/>
            <span style="color:var(--sb-muted)">Examples: ${sec.examples}</span><br/><br/>
            <strong>Don't worry if you're unsure of every detail</strong> — just fill in what you know. Click Next to skip this category if it doesn't apply to your team.
          </p>
          <div id="tools-wrap-${sec.id}">
            ${tools.length === 0
              ? `<div class="empty-section-msg"><strong>No tools added yet</strong>Click the button below if your team uses any ${sec.title.toLowerCase()} software.</div>`
              : tools.map((t, i) => toolCardHTML(sec.id, i, t)).join('')}
          </div>
          <button class="add-tool-btn" onclick="addTool('${sec.id}')">+ Add another ${sec.title.toLowerCase()} tool</button>
        </div>`;

      } else if (sec.type === 'comments') {
        body.innerHTML = `<div class="survey-page">
          <p class="survey-instruction">Is there anything else you'd like to tell us? Tools you're trialing, something you weren't sure how to categorize, or anything else on your mind.</p>
          <div class="contact-field" style="margin-top:1rem">
            <label>Additional comments <span style="color:var(--sb-muted);font-weight:400">(optional)</span></label>
            <textarea class="ti" rows="6" data-key="comments" placeholder="Anything else...">${escHtml(surveyData.comments||'')}</textarea>
          </div>
        </div>`;

      } else if (sec.type === 'review') {
        const toolCount = Object.values(toolData).flat().filter(t => t.name?.trim()).length;
        body.innerHTML = `<div class="survey-page">
          <p class="survey-instruction">You're almost done! Here's a summary of what you've filled in. Click <strong>Submit Survey</strong> when you're ready.</p>
          <div class="review-box">
            <div class="review-row"><span>Name</span>          <strong>${escHtml(surveyData.info_name  || '—')}</strong></div>
            <div class="review-row"><span>Job Title</span>     <strong>${escHtml(surveyData.info_title || '—')}</strong></div>
            <div class="review-row"><span>Department</span>    <strong>${escHtml(surveyData.info_dept  || '—')}</strong></div>
            <div class="review-row"><span>Email</span>         <strong>${escHtml(surveyData.info_email || '—')}</strong></div>
            <div class="review-row"><span>Date</span>          <strong>${escHtml(surveyData.info_date  || '—')}</strong></div>
            <div class="review-row"><span>Tools recorded</span><strong>${toolCount} tool${toolCount !== 1 ? 's' : ''}</strong></div>
          </div>
          <p class="survey-instruction" style="margin-top:1.25rem">By submitting you confirm this information is accurate to the best of your knowledge.</p>
          <div id="submitStatus" class="contact-status" style="margin-top:0.75rem"></div>
        </div>`;
      }

      window.scrollTo(0, 0);
    }

    // ── Save step ──────────────────────────────────────────────────
    function saveStep() {
      // Save info fields
      document.querySelectorAll('#surveyBody [data-key]').forEach(el => {
        surveyData[el.dataset.key] = el.value;
      });

      // Save tool cards for current tool section
      const sec = activeSections[currentStep];
      if (sec?.type === 'tools') {
        const cards = document.querySelectorAll(`#tools-wrap-${sec.id} .tool-card`);
        toolData[sec.id] = [];
        cards.forEach(card => {
          const tool = {};
          card.querySelectorAll('[data-field]').forEach(el => {
            tool[el.dataset.field] = el.value;
          });
          toolData[sec.id].push(tool);
        });
      }
    }

    // ── Validation ─────────────────────────────────────────────────
    function validateStep(idx) {
      if (activeSections[idx]?.type !== 'info') return true;
      const required = ['info_name','info_title','info_dept','info_email','info_date'];
      for (const key of required) {
        if (!surveyData[key] || surveyData[key].trim() === '') {
          alert('Please fill in all the fields before continuing.');
          return false;
        }
      }
      return true;
    }

    // ── Navigation ─────────────────────────────────────────────────
    function goToStep(idx) {
      currentStep = idx;
      renderStep(idx);
    }

    function surveyNav(dir) {
      saveStep();
      if (activeSections[currentStep]?.type === 'info' && dir === 1) {
        if (!validateStep(currentStep)) return;
        activeSections = buildSections(surveyData.info_dept);
        buildStepNav();
      }
      if (dir === 1 && currentStep === activeSections.length - 1) {
        submitSurvey(); return;
      }
      goToStep(currentStep + dir);
    }

    // ── Build flat payload for Google Sheets ───────────────────────
    function buildPayload() {
      const payload = { ...surveyData, submitted_at: new Date().toISOString() };
      Object.entries(toolData).forEach(([sid, tools]) => {
        tools.forEach((tool, r) => {
          const base = `${sid}_r${r}`;
          payload[`${base}_name`]  = tool.name  || '';
          payload[`${base}_who`]   = tool.who   || '';
          payload[`${base}_login`] = tool.login || '';
          payload[`${base}_notes`] = tool.notes || '';
          // Map to existing Apps Script fields so the sheet still works
          payload[`${base}_active`]   = '';
          payload[`${base}_acct`]     = '';
          payload[`${base}_alldept`]  = tool.who === 'Whole department' || tool.who === 'Multiple departments';
          payload[`${base}_myself`]   = tool.who === 'Just me';
          payload[`${base}_perm`]     = '';
        });
      });
      return payload;
    }

    // ── Submit ─────────────────────────────────────────────────────
    async function submitSurvey() {
      const btn  = document.getElementById('nextBtn');
      const stat = document.getElementById('submitStatus');
      btn.textContent = 'Submitting...';
      btn.disabled    = true;

      const payload = buildPayload();

      fetch(SHEET_ENDPOINT, {
        method: 'POST', mode: 'no-cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      }).catch(e => console.warn('Sheet write failed:', e));

      const saved = await window.saveSubmission({
        title: 'Technology & Application Discovery Survey',
        dept:  surveyData.info_dept || '—',
        url:   'surveys/tech-discovery.html',
      });

      if (saved) {
        if (stat) {
          stat.textContent = '✅ Survey submitted! Redirecting you back to the portal...';
          stat.className   = 'contact-status success';
        }
        btn.textContent = 'Submitted ✓';
        setTimeout(() => window.location.href = '../index.html', 2500);
      } else {
        if (stat) {
          stat.textContent = '❌ Submission failed. Please try again or contact itsupport@rowecasaorganics.com.';
          stat.className   = 'contact-status error';
        }
        btn.textContent = 'Submit Survey ✓';
        btn.disabled    = false;
      }
    }

    // ── Init ───────────────────────────────────────────────────────
    function init() {
      activeSections = [
        { id: 'info',     title: 'About You',          type: 'info'     },
        { id: 'comments', title: 'Additional Comments', type: 'comments' },
        { id: 'review',   title: 'Review & Submit',    type: 'review'   },
      ];
      buildStepNav();
      renderStep(0);
    }

    init();
  </script>

</body>
</html>
