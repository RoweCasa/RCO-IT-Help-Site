<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Technology & Application Discovery Survey — RCO IT</title>
  <link rel="stylesheet" href="../styles.css"/>
  <style>
    /* ── Page layout ── */
    .survey-single-page { max-width: 780px; margin: 0 auto; }

    .survey-header-block {
      margin-bottom: 2rem;
      padding-bottom: 1.5rem;
      border-bottom: 1px solid var(--sb-sep);
    }

    .survey-header-block h2 {
      font-size: 1.4rem;
      font-weight: 800;
      color: var(--sb-text);
      margin-bottom: 0.4rem;
    }

    .survey-header-block p {
      color: var(--sb-muted);
      font-size: 0.875rem;
      line-height: 1.6;
    }

    /* ── Info grid ── */
    .info-grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
      margin-bottom: 2rem;
    }
    @media(max-width:600px){ .info-grid-2 { grid-template-columns: 1fr; } }

    .field-wrap { display: flex; flex-direction: column; gap: 0.35rem; }
    .field-wrap label {
      font-size: 0.82rem;
      font-weight: 700;
      color: var(--sb-text);
    }
    .field-wrap input,
    .field-wrap select,
    .field-wrap textarea {
      background: var(--sidebar-bg);
      border: 1.5px solid var(--sb-border);
      border-radius: 9px;
      padding: 0.6rem 0.85rem;
      font-size: 0.875rem;
      font-family: inherit;
      color: var(--sb-text);
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s;
      width: 100%;
    }
    .field-wrap input:focus,
    .field-wrap select:focus,
    .field-wrap textarea:focus {
      border-color: var(--brand-hover-border);
      box-shadow: 0 0 0 3px rgba(189,153,121,0.15);
    }

    /* ── Tools section ── */
    .tools-section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin: 2rem 0 1rem;
      padding-top: 1.5rem;
      border-top: 1px solid var(--sb-sep);
    }

    .tools-section-header h3 {
      font-size: 1.1rem;
      font-weight: 800;
      color: var(--sb-text);
    }

    .examples-btn {
      background: var(--brand-soft);
      border: 1.5px solid var(--brand-hover-border);
      color: var(--brand-brown);
      font-size: 0.78rem;
      font-weight: 700;
      font-family: inherit;
      padding: 0.38rem 0.85rem;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.15s;
    }
    .examples-btn:hover {
      background: var(--brand-grad);
      color: #fff;
      border-color: var(--brand-brown);
    }

    /* ── Tool card ── */
    .tool-card {
      background: var(--sidebar-bg);
      border: 1.5px solid var(--sb-border);
      border-radius: 14px;
      padding: 1.25rem 1.5rem;
      margin-bottom: 1rem;
      transition: border-color 0.18s;
    }
    .tool-card:hover { border-color: var(--brand-hover-border); }

    .tool-card-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 1rem;
    }

    .tool-card-num {
      font-size: 0.72rem;
      font-weight: 800;
      color: var(--sb-muted);
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .tool-card-remove {
      background: none;
      border: none;
      color: var(--sb-muted);
      font-size: 0.78rem;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: color 0.15s;
      padding: 0;
    }
    .tool-card-remove:hover { color: #c0392b; }

    .tool-grid-3 {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr;
      gap: 0.85rem;
      margin-bottom: 0.85rem;
    }
    .tool-grid-2 {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.85rem;
      margin-bottom: 0.85rem;
    }
    @media(max-width:600px){
      .tool-grid-3, .tool-grid-2 { grid-template-columns: 1fr; }
    }

    .field-hint {
      font-size: 0.72rem;
      color: var(--sb-muted);
      margin-top: 0.2rem;
    }

    /* ── Severity stars ── */
    .severity-wrap {
      display: flex;
      gap: 0.4rem;
      margin-top: 0.25rem;
      align-items: center;
    }

    .sev-btn {
      width: 36px;
      height: 36px;
      border-radius: 8px;
      border: 1.5px solid var(--sb-border);
      background: var(--panel-bg);
      font-size: 0.85rem;
      font-weight: 800;
      font-family: inherit;
      color: var(--sb-muted);
      cursor: pointer;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .sev-btn:hover { border-color: var(--brand-hover-border); color: var(--brand-brown); }
    .sev-btn.selected { background: var(--brand-grad); border-color: var(--brand-brown); color: #fff; }

    .sev-labels {
      display: flex;
      justify-content: space-between;
      font-size: 0.68rem;
      color: var(--sb-muted);
      margin-top: 0.2rem;
    }

    /* ── Who pills ── */
    .pill-group {
      display: flex;
      gap: 0.4rem;
      flex-wrap: wrap;
      margin-top: 0.25rem;
    }

    .pill-btn {
      padding: 0.35rem 0.8rem;
      border-radius: 999px;
      border: 1.5px solid var(--sb-border);
      background: var(--panel-bg);
      color: var(--sb-text);
      font-size: 0.78rem;
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.15s;
    }
    .pill-btn:hover { border-color: var(--brand-hover-border); }
    .pill-btn.selected { background: var(--brand-grad); border-color: var(--brand-brown); color: #fff; }

    /* ── Add tool button ── */
    .add-tool-btn {
      width: 100%;
      padding: 0.85rem;
      border: 2px dashed var(--sb-border);
      border-radius: 14px;
      background: none;
      color: var(--sb-muted);
      font-size: 0.875rem;
      font-weight: 700;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.18s;
      margin-bottom: 2rem;
    }
    .add-tool-btn:hover {
      border-color: var(--brand-hover-border);
      color: var(--brand-brown);
      background: var(--brand-soft);
    }

    /* ── Submit section ── */
    .submit-section {
      border-top: 1px solid var(--sb-sep);
      padding-top: 1.5rem;
      margin-top: 1rem;
    }

    .submit-section textarea {
      width: 100%;
      background: var(--sidebar-bg);
      border: 1.5px solid var(--sb-border);
      border-radius: 9px;
      padding: 0.6rem 0.85rem;
      font-size: 0.875rem;
      font-family: inherit;
      color: var(--sb-text);
      outline: none;
      resize: vertical;
      margin-top: 0.35rem;
      transition: border-color 0.15s, box-shadow 0.15s;
    }
    .submit-section textarea:focus {
      border-color: var(--brand-hover-border);
      box-shadow: 0 0 0 3px rgba(189,153,121,0.15);
    }

    /* ── Modal ── */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      backdrop-filter: blur(6px);
      z-index: 300;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }
    .modal-overlay.hidden { display: none; }

    .modal-box {
      background: var(--panel-bg);
      border: 1.5px solid var(--sb-border);
      border-radius: 20px;
      padding: 2rem;
      max-width: 640px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.2);
    }

    .modal-box h3 {
      font-size: 1.1rem;
      font-weight: 800;
      color: var(--sb-text);
      margin-bottom: 1.25rem;
    }

    .modal-category { margin-bottom: 1.25rem; }

    .modal-category h4 {
      font-size: 0.8rem;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--sb-muted);
      margin-bottom: 0.5rem;
    }

    .modal-apps {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
    }

    .modal-app-tag {
      background: var(--sidebar-bg);
      border: 1px solid var(--sb-border);
      border-radius: 8px;
      padding: 0.28rem 0.65rem;
      font-size: 0.78rem;
      color: var(--sb-text);
      font-weight: 600;
    }

    .modal-close {
      width: 100%;
      margin-top: 1.5rem;
      padding: 0.65rem;
      background: var(--brand-grad);
      color: #fff;
      border: none;
      border-radius: 10px;
      font-size: 0.875rem;
      font-weight: 700;
      font-family: inherit;
      cursor: pointer;
    }

    .skip-note {
      font-size: 0.72rem;
      color: var(--sb-muted);
      margin-top: 0.3rem;
      font-style: italic;
    }
  </style>
</head>
<body>

  <div class="app-shell">

    <!-- SIDEBAR -->
    <aside class="sidebar">
      <div class="sidebar-logo-wrap">
        <img src="../logo.png" alt="Rowe Casa Organics" class="sidebar-logo"/>
      </div>
      <div class="sidebar-divider"></div>
      <nav class="sidebar-nav">
        <button class="nav-btn active" onclick="scrollTo(0,0)">Your Information</button>
        <button class="nav-btn" onclick="document.getElementById('tools-section').scrollIntoView({behavior:'smooth'})">Tools & Software</button>
        <button class="nav-btn" onclick="document.getElementById('submit-section').scrollIntoView({behavior:'smooth'})">Submit</button>
      </nav>
      <div class="sidebar-footer">
        <div class="sidebar-divider"></div>
        <button class="contact-btn" onclick="window.location.href='../index.html'">← Back to Portal</button>
        <div class="portal-label">RCO IT Help Site</div>
        <div class="portal-sub">@rowecasaorganics.com</div>
      </div>
    </aside>

    <!-- MAIN -->
    <div class="main-wrap">
      <header class="topbar">
        <div class="topbar-left">
          <div class="topbar-title">Technology & Application Discovery Survey</div>
          <div class="topbar-desc">Help us track every app and software your team uses — web, desktop, or licensed.</div>
        </div>
      </header>

      <main class="content-panel">
        <div class="survey-single-page" id="surveyPage">

          <!-- ── Your Information ── -->
          <div class="survey-header-block">
            <h2>Your Information</h2>
            <p>Tell us a little about yourself so we know who submitted this survey.</p>
          </div>

          <div class="info-grid-2">
            <div class="field-wrap">
              <label>Full Name</label>
              <input type="text" id="info_name" placeholder="Your full name"/>
            </div>
            <div class="field-wrap">
              <label>Job Title</label>
              <input type="text" id="info_title" placeholder="Your job title"/>
            </div>
            <div class="field-wrap">
              <label>Department</label>
              <select id="info_dept">
                <option value="">— Select your department —</option>
                <option>Administration</option><option>Brand Experience</option>
                <option>Curing</option><option>Customer Care</option>
                <option>Customer Service</option><option>Facilities and Maintenance</option>
                <option>Finance</option><option>Human Resources</option>
                <option>Information Technology</option><option>Inventory</option>
                <option>Kitchen</option><option>Labeling</option>
                <option>Marketing</option><option>Operations</option>
                <option>Procurement</option><option>Production</option>
                <option>Project Management</option><option>Quality Control</option>
                <option>Research &amp; Development</option><option>Shipping</option>
                <option>Social Media</option><option>Strategy</option>
                <option>Wholesale</option>
              </select>
            </div>
            <div class="field-wrap">
              <label>Work Email</label>
              <input type="email" id="info_email" placeholder="yourname@rowecasaorganics.com"/>
            </div>
            <div class="field-wrap">
              <label>Today's Date</label>
              <input type="date" id="info_date"/>
            </div>
          </div>

          <!-- ── Tools Section ── -->
          <div id="tools-section">
            <div class="tools-section-header">
              <h3>Tools &amp; Software</h3>
              <button class="examples-btn" onclick="openModal()">View App Examples</button>
            </div>
            <p style="font-size:0.85rem;color:var(--sb-muted);margin-bottom:1.25rem;line-height:1.6">
              List every app, program, or software your team uses — whether it's a website you log into (like Asana), 
              a program installed on your computer (like Adobe Acrobat), or anything that's licensed or regularly used for work.<br/>
              <strong style="color:var(--sb-text)">Skip any field you're unsure about — just fill in what you know.</strong>
            </p>

            <div id="toolsList"></div>

            <button class="add-tool-btn" onclick="addTool()">+ Add a tool or app</button>
          </div>

          <!-- ── Submit ── -->
          <div class="submit-section" id="submit-section">
            <div class="survey-header-block" style="border:none;padding:0;margin-bottom:1rem">
              <h2>Additional Comments</h2>
              <p>Anything else we should know? Tools being trialed, tools you're unsure about, or anything on your mind.</p>
            </div>
            <div class="field-wrap">
              <label>Comments <span style="font-weight:400;color:var(--sb-muted)">(optional)</span></label>
              <textarea id="comments" rows="4" placeholder="Optional..."></textarea>
            </div>
            <div style="margin-top:1.5rem">
              <button class="card-action" style="padding:0.75rem 2rem;font-size:0.95rem" onclick="submitSurvey()" id="submitBtn">Submit Survey →</button>
            </div>
            <div id="submitStatus" class="contact-status" style="margin-top:0.75rem"></div>
          </div>

        </div>
      </main>
    </div>
  </div>

  <!-- ── Examples Modal ── -->
  <div class="modal-overlay hidden" id="examplesModal">
    <div class="modal-box">
      <h3>App &amp; Software Examples by Category</h3>
      <div id="modalContent"></div>
      <button class="modal-close" onclick="closeModal()">Close</button>
    </div>
  </div>

  <!-- Google Sheets endpoint -->
  <script>
    const SHEET_ENDPOINT = 'https://script.google.com/macros/s/AKfycbxeP-Asvk9kgGx_oz4jMWYOBldaPLM8Tm6S2XfXOfDRat-3KX1UfVXYzEju2Dc7nDwBGg/exec';
  </script>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp, getApps, getApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFirestore, collection, addDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    const FIREBASE_CONFIG = {
      apiKey:            "AIzaSyBRKBzxTYzBnBHo-YY8fSxTSSkM3uyujmc",
      authDomain:        "ithelpsite-4ec53.firebaseapp.com",
      projectId:         "ithelpsite-4ec53",
      storageBucket:     "ithelpsite-4ec53.firebasestorage.app",
      messagingSenderId: "893459212285",
      appId:             "1:893459212285:web:194adf30886cbb28c21b94",
      measurementId:     "G-H6WM1LWQ4V"
    };

    const app  = getApps().length ? getApp() : initializeApp(FIREBASE_CONFIG);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    onAuthStateChanged(auth, user => {
      if (!user || !user.email.endsWith('@rowecasaorganics.com')) {
        signOut(auth).finally(() => window.location.replace('../login.html'));
        return;
      }
      window._currentUser = user;
    });

    window.saveSubmission = async function(data) {
      if (!window._currentUser) {
        await new Promise(resolve => {
          const unsub = onAuthStateChanged(auth, user => {
            if (user) { window._currentUser = user; unsub(); resolve(); }
          });
          setTimeout(resolve, 5000);
        });
      }
      if (!window._currentUser) return false;
      try {
        await addDoc(collection(db, 'submissions'), {
          ...data,
          uid:         window._currentUser.uid,
          userEmail:   window._currentUser.email,
          submittedAt: serverTimestamp(),
        });
        return true;
      } catch (err) {
        console.error('Firestore save failed:', err);
        return false;
      }
    };
  </script>

  <!-- Main script -->
  <script>
    // ── App examples by category ───────────────────────────────────
    const APP_EXAMPLES = {
      'Communication':               ['Gmail','Slack','Microsoft Teams','Zoom','Outlook','Google Meet','Loom','RingCentral'],
      'Productivity & File Storage': ['Google Drive','Dropbox','Microsoft 365','OneDrive','Notion','Box','SharePoint','Evernote'],
      'Project Management':          ['Asana','Monday.com','Trello','ClickUp','Basecamp','Smartsheet','Jira','Wrike'],
      'HR & People':                 ['BambooHR','ADP','Gusto','Rippling','Workday','Lattice','Greenhouse','Lever'],
      'Finance & Accounting':        ['QuickBooks','Expensify','Bill.com','NetSuite','Xero','FreshBooks','Sage','Concur'],
      'Sales & CRM':                 ['Salesforce','HubSpot','Pipedrive','Zoho CRM','Copper','Close','Zendesk'],
      'Marketing':                   ['Mailchimp','Klaviyo','Hootsuite','Google Analytics','Meta Ads','Semrush','Buffer','ActiveCampaign'],
      'IT & Security':               ['1Password','LastPass','CrowdStrike','Okta','Jamf','NordVPN','Malwarebytes','Duo'],
      'Design & Creative':           ['Adobe Acrobat','Adobe Creative Cloud','Canva','Figma','InDesign','Photoshop','Illustrator','CapCut'],
      'Operations & Logistics':      ['ShipStation','ShipBob','Cin7','Fishbowl','NetSuite','Brightpearl','Extensiv','ZebraDesigner'],
      'Other':                       ['Any browser extensions','Specialty tools','Industry-specific software','Custom-built tools'],
    };

    // ── Tool counter ───────────────────────────────────────────────
    let toolCount = 0;

    // ── Add tool ───────────────────────────────────────────────────
    function addTool() {
      const idx  = toolCount++;
      const div  = document.createElement('div');
      div.className = 'tool-card';
      div.id        = `tool-${idx}`;
      div.innerHTML = toolCardHTML(idx);
      document.getElementById('toolsList').appendChild(div);
      div.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function toolCardHTML(idx) {
      return `
        <div class="tool-card-top">
          <span class="tool-card-num">Tool ${idx + 1}</span>
          <button class="tool-card-remove" onclick="removeTool(${idx})">✕ Remove</button>
        </div>

        <!-- Row 1: name, category, severity -->
        <div class="tool-grid-3">
          <div class="field-wrap">
            <label>App / Software Name</label>
            <input type="text" id="t${idx}_name" placeholder="e.g. Asana, Adobe Acrobat, Slack"/>
            <div class="field-hint">Web app, desktop program, or licensed software</div>
          </div>
          <div class="field-wrap">
            <label>Category</label>
            <select id="t${idx}_category">
              <option value="">— Select —</option>
              <option>Communication</option>
              <option>Productivity & File Storage</option>
              <option>Project Management</option>
              <option>HR & People</option>
              <option>Finance & Accounting</option>
              <option>Sales & CRM</option>
              <option>Marketing</option>
              <option>IT & Security</option>
              <option>Design & Creative</option>
              <option>Operations & Logistics</option>
              <option>Other</option>
            </select>
            <div class="field-hint">Skip if unsure</div>
          </div>
          <div class="field-wrap">
            <label>How critical is this to your job?</label>
            <div class="severity-wrap">
              ${[1,2,3,4,5].map(n => `<button type="button" class="sev-btn" id="t${idx}_sev_${n}" onclick="setSeverity(${idx},${n})">${n}</button>`).join('')}
              <input type="hidden" id="t${idx}_severity" value=""/>
            </div>
            <div class="sev-labels"><span>Not critical</span><span>Essential</span></div>
            <div class="field-hint">Skip if unsure</div>
          </div>
        </div>

        <!-- Row 2: who uses it, admin access -->
        <div class="tool-grid-2">
          <div class="field-wrap">
            <label>Who uses this tool?</label>
            <div class="pill-group" id="t${idx}_who_pills">
              ${['Just me','My team','Whole department'].map(o =>
                `<button type="button" class="pill-btn" onclick="setPill('t${idx}_who', this, '${o}')">${o}</button>`
              ).join('')}
            </div>
            <input type="hidden" id="t${idx}_who" value=""/>
            <div class="field-hint">Skip if unsure</div>
          </div>
          <div class="field-wrap">
            <label>Do you have admin access?</label>
            <div class="pill-group">
              ${['Yes','No',"I don't know"].map(o =>
                `<button type="button" class="pill-btn" onclick="setPill('t${idx}_admin', this, '${o}')">${o}</button>`
              ).join('')}
            </div>
            <input type="hidden" id="t${idx}_admin" value=""/>
          </div>
        </div>

        <!-- Row 3: login email, owner -->
        <div class="tool-grid-2">
          <div class="field-wrap">
            <label>What email do you log in with?</label>
            <input type="text" id="t${idx}_login" placeholder="e.g. hayden@rowecasaorganics.com"/>
            <div class="field-hint">Skip if you're not sure or it doesn't apply</div>
          </div>
          <div class="field-wrap">
            <label>Who owns or manages this app?
              <span class="owner-tip" title="This is the person responsible for the subscription or license — e.g. BambooHR → Chris Pauline, Google Workspace → Philip Williams"
                style="cursor:help;color:var(--brand-brown);font-weight:400;margin-left:4px">(?)</span>
            </label>
            <input type="text" id="t${idx}_owner" placeholder="e.g. Chris Pauline, Philip Williams"/>
            <div class="field-hint">The person who pays for or administers the account. Skip if unknown.</div>
          </div>
        </div>

        <!-- Notes -->
        <div class="field-wrap" style="margin-top:0.25rem">
          <label>Any other notes? <span style="font-weight:400;color:var(--sb-muted)">(optional)</span></label>
          <input type="text" id="t${idx}_notes" placeholder="e.g. trial version, rarely used, shared login"/>
        </div>
      `;
    }

    // ── Remove tool ────────────────────────────────────────────────
    function removeTool(idx) {
      const el = document.getElementById(`tool-${idx}`);
      if (el) el.remove();
    }

    // ── Severity selector ──────────────────────────────────────────
    function setSeverity(idx, val) {
      [1,2,3,4,5].forEach(n => {
        document.getElementById(`t${idx}_sev_${n}`)?.classList.toggle('selected', n <= val);
      });
      document.getElementById(`t${idx}_severity`).value = val;
    }

    // ── Pill selector ──────────────────────────────────────────────
    function setPill(fieldId, btn, val) {
      btn.closest('.pill-group').querySelectorAll('.pill-btn').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
      document.getElementById(fieldId).value = val;
    }

    // ── Modal ──────────────────────────────────────────────────────
    function openModal() {
      const content = document.getElementById('modalContent');
      content.innerHTML = Object.entries(APP_EXAMPLES).map(([cat, apps]) => `
        <div class="modal-category">
          <h4>${cat}</h4>
          <div class="modal-apps">
            ${apps.map(a => `<span class="modal-app-tag">${a}</span>`).join('')}
          </div>
        </div>
      `).join('');
      document.getElementById('examplesModal').classList.remove('hidden');
    }

    function closeModal() {
      document.getElementById('examplesModal').classList.add('hidden');
    }

    // Click outside modal to close
    document.getElementById('examplesModal').addEventListener('click', function(e) {
      if (e.target === this) closeModal();
    });

    // ── Collect all tool data ──────────────────────────────────────
    function collectTools() {
      const tools = [];
      document.querySelectorAll('.tool-card').forEach((card, r) => {
        const idx = card.id.replace('tool-','');
        const name = document.getElementById(`t${idx}_name`)?.value?.trim();
        if (!name) return; // skip blank cards
        tools.push({
          idx: r,
          name,
          category: document.getElementById(`t${idx}_category`)?.value  || '',
          severity: document.getElementById(`t${idx}_severity`)?.value  || '',
          who:      document.getElementById(`t${idx}_who`)?.value        || '',
          admin:    document.getElementById(`t${idx}_admin`)?.value      || '',
          login:    document.getElementById(`t${idx}_login`)?.value      || '',
          owner:    document.getElementById(`t${idx}_owner`)?.value      || '',
          notes:    document.getElementById(`t${idx}_notes`)?.value      || '',
        });
      });
      return tools;
    }

    // ── Build flat payload for Google Sheets ──────────────────────
    function buildPayload(tools) {
      const payload = {
        info_name:    document.getElementById('info_name')?.value  || '',
        info_title:   document.getElementById('info_title')?.value || '',
        info_dept:    document.getElementById('info_dept')?.value  || '',
        info_email:   document.getElementById('info_email')?.value || '',
        info_date:    document.getElementById('info_date')?.value  || '',
        comments:     document.getElementById('comments')?.value   || '',
        submitted_at: new Date().toISOString(),
      };
      tools.forEach((tool, r) => {
        const base = `other_r${r}`; // use 'other' as generic section key
        payload[`${base}_name`]     = tool.name;
        payload[`${base}_category`] = tool.category;
        payload[`${base}_severity`] = tool.severity;
        payload[`${base}_who`]      = tool.who;
        payload[`${base}_admin`]    = tool.admin;
        payload[`${base}_login`]    = tool.login;
        payload[`${base}_owner`]    = tool.owner;
        payload[`${base}_notes`]    = tool.notes;
      });
      return payload;
    }

    // ── Submit ─────────────────────────────────────────────────────
    async function submitSurvey() {
      const btn  = document.getElementById('submitBtn');
      const stat = document.getElementById('submitStatus');

      // Basic validation
      const name  = document.getElementById('info_name')?.value?.trim();
      const dept  = document.getElementById('info_dept')?.value;
      const email = document.getElementById('info_email')?.value?.trim();
      if (!name || !dept || !email) {
        stat.textContent = 'Please fill in your name, department, and email before submitting.';
        stat.className   = 'contact-status error';
        document.getElementById('info_name').scrollIntoView({ behavior: 'smooth', block: 'center' });
        return;
      }

      btn.textContent = 'Submitting...';
      btn.disabled    = true;

      const tools   = collectTools();
      const payload = buildPayload(tools);

      // Fire to Google Sheets
      fetch(SHEET_ENDPOINT, {
        method: 'POST', mode: 'no-cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      }).catch(e => console.warn('Sheet write failed:', e));

      // Save to Firestore
      const saved = await window.saveSubmission({
        title: 'Technology & Application Discovery Survey',
        dept:  payload.info_dept || '—',
        url:   'surveys/tech-discovery.html',
      });

      if (saved) {
        stat.textContent = '✅ Survey submitted! Redirecting you back to the portal...';
        stat.className   = 'contact-status success';
        btn.textContent  = 'Submitted ✓';
        setTimeout(() => window.location.href = '../index.html', 2500);
      } else {
        stat.textContent = '❌ Submission failed. Please try again or contact itsupport@rowecasaorganics.com.';
        stat.className   = 'contact-status error';
        btn.textContent  = 'Submit Survey →';
        btn.disabled     = false;
      }
    }
  </script>

</body>
</html>
